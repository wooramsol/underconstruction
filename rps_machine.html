<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Unbeatable RPS Machine</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #2c3e50;
            color: white;
            margin: 0; padding: 0;
            width: 100vw; height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        header {
            flex: 0 0 auto;
            text-align: center;
            /* [ìˆ˜ì •] ìƒë‹¨ íŒ¨ë”© ê°ì†Œ */
            padding: 10px 5px;
            background-color: #2c3e50;
            z-index: 10;
        }
        /* [ìˆ˜ì •] íƒ€ì´í‹€ í¬ê¸° ì¶•ì†Œ (í•œ ì¤„ ë§ì¶¤) */
        h1 { margin: 0; font-weight: 800; font-size: 0.9rem; line-height: 1.2; }
        /* [ìˆ˜ì •] ì„œë¸Œíƒ€ì´í‹€ ê°„ê²© ê°ì†Œ */
        .subtitle { margin: 0; color: #bdc3c7; font-size: 0.75rem; margin-top: 2px; }
        
        /* [ìˆ˜ì •] ì„¤ëª…ê¸€ ê°„ê²© ë° í¬ê¸° ê°ì†Œ */
        .description { 
            font-size: 0.7rem; 
            color: #bdc3c7; 
            margin-top: 3px; /* íƒ€ì´í‹€ê³¼ ë” ê°€ê¹ê²Œ */
            line-height: 1.3; 
            max-width: 600px; 
            margin-left: auto; 
            margin-right: auto;
        }
        .highlight { color: #f1c40f; font-weight: bold; }
        .bold-text { font-weight: bold; color: white; }

        /* === [ëª¨ë°”ì¼ ë ˆì´ì•„ì›ƒ] === */
        .game-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-evenly;
            /* [ìˆ˜ì •] ì»¨í…Œì´ë„ˆ íŒ¨ë”© ë° ê°„ê²© ìµœì†Œí™” */
            padding: 5px;
            gap: 5px;
            width: 100%;
            margin: 0 auto;
            overflow: hidden;
        }

        .player-section, .machine-section {
            width: 100%;
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 0;
            /* [ìˆ˜ì •] ì„¹ì…˜ ê°„ê²© ê°ì†Œ */
            margin-bottom: 2px;
        }

        .info-bar {
            display: flex;
            justify-content: space-between;
            width: 100%;
            padding: 0 5px;
            /* [ìˆ˜ì •] ì •ë³´ë°” ê°„ê²© ê°ì†Œ */
            margin-bottom: 2px;
            align-items: flex-end;
            flex: 0 0 auto;
        }
        h2 { margin: 0; font-size: 0.9rem; }
        .score-display { font-size: 0.9rem; font-weight: bold; color: #f1c40f; }

        .video-wrapper, .result-wrapper {
            width: 100%;
            height: 100%;
            /* [ìˆ˜ì •] ìµœëŒ€ ë†’ì´ ì œí•œì„ ì•½ê°„ ëŠ˜ë ¤ ë¹„ìœ¨ ìœ ì§€ */
            max-height: 42vh;
            border-radius: 12px;
            border: 3px solid #3498db;
            background-color: #000;
            position: relative;
            overflow: hidden; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        .result-wrapper {
            border-color: #95a5a6;
            background-color: #ecf0f1;
            display: flex;
            justify-content: center;
            align-items: center;
            /* [ìˆ˜ì •] ì´ëª¨ì§€ í¬ê¸° ì•½ê°„ ê°ì†Œ */
            font-size: 4.5rem; 
            color: #2c3e50;
        }

        .vs-section {
            flex: 0 0 auto;
            font-size: 1.2rem;
            font-weight: 900;
            font-style: italic;
            color: #ecf0f1;
            margin: -2px 0;
            z-index: 5;
            text-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        #input_video { display: none; }
        
        #output_canvas {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scaleX(-1);
            width: auto;
            height: auto;
        }

        #status_text {
            flex: 0 0 auto;
            /* [ìˆ˜ì •] í•˜ë‹¨ ë°” íŒ¨ë”© ê°ì†Œ */
            padding: 10px 5px;
            font-size: 1rem;
            font-weight: bold;
            color: #f1c40f;
            text-align: center;
            background-color: #2c3e50;
            width: 100%;
        }

        .loading {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: white; font-weight: bold;
            font-size: 1rem;
            z-index: 10;
        }

        /* === [PC ë ˆì´ì•„ì›ƒ] === */
        @media (min-width: 900px) {
            /* [ìˆ˜ì •] PCì—ì„œë„ ë¹„ìœ¨ì— ë§ì¶° í¬ê¸° ì•½ê°„ ì¶•ì†Œ */
            h1 { font-size: 1.2rem; }
            .subtitle { font-size: 0.9rem; }
            .description { font-size: 0.9rem; }

            .game-container {
                flex-direction: row;
                align-items: flex-start;
                gap: 50px;
                max-width: 1200px;
                /* [ìˆ˜ì •] PC ìƒë‹¨ ì—¬ë°± ê°ì†Œ */
                padding-top: 20px;
            }

            .player-section, .machine-section {
                width: 420px;
                flex: 0 0 auto;
                max-width: none;
            }

            .video-wrapper, .result-wrapper {
                width: 400px;
                height: 300px;
                max-height: none;
                border-width: 4px;
            }

            .result-wrapper { font-size: 120px; }

            .vs-section {
                font-size: 3rem;
                margin: 0;
                padding-top: 100px;
                display: flex;
                align-items: center;
            }
            
            h2, .score-display { font-size: 1.5rem; }
            /* [ìˆ˜ì •] PC í•˜ë‹¨ ë°” í¬ê¸° ë° ì—¬ë°± ê°ì†Œ */
            #status_text { font-size: 1.2rem; padding-bottom: 15px; }
        }
    </style>
</head>
<body>

    <header>
        <h1>ğŸ¤– Unbeatable Rock Paper Scissors Machine</h1>
        <p class="subtitle">Designed by Ramsol</p>
        <p class="description">
            <br>
            <span class="bold-text">Why is it unbeatable?</span><br>
            Human reaction time is 0.25s, but this AI needs only <span class="highlight">0.03s</span>.<br>
            It reads your move faster than you can blink.
        </p>
    </header>

    <div class="game-container">
        <div class="player-section">
            <div class="info-bar">
                <h2>You</h2>
                <div class="score-display">Wins: <span id="player_score">0</span></div>
            </div>
            <div class="video-wrapper" id="videoWrapper">
                <div class="loading">Loading...</div>
                <video id="input_video" playsinline></video>
                <canvas id="output_canvas"></canvas>
            </div>
        </div>

        <div class="vs-section">VS</div>

        <div class="machine-section">
            <div class="info-bar">
                <h2>RPS Machine</h2>
                <div class="score-display">Wins: <span id="machine_score">0</span></div>
            </div>
            <div class="result-wrapper">
                <div id="machine_result_emoji">âš™ï¸</div>
            </div>
        </div>
    </div>

    <div id="status_text">Show your hand!</div>
    <audio id="loseSound" src="https://actions.google.com/sounds/v1/cartoon/pop.ogg" preload="auto"></audio>

    <script>
        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const machineResultElement = document.getElementById('machine_result_emoji');
        const statusText = document.getElementById('status_text');
        const loadingMsg = document.querySelector('.loading');
        const machineScoreEl = document.getElementById('machine_score');
        const loseSound = document.getElementById('loseSound');
        const videoWrapper = document.getElementById('videoWrapper');
        loseSound.volume = 0.6;

        let machineScore = 0;
        let lastWinTime = 0; 
        const COOLDOWN_MS = 500; 
        let modelLoaded = false;
        let previousGesture = null;

        const EMOTIONS = { 'Rock': 'âœŠ', 'Paper': 'ğŸ–ï¸', 'Scissors': 'âœŒï¸', 'Unknown': 'â“' };

        // ìº”ë²„ìŠ¤ ë¹„ìœ¨ ìë™ ë§ì¶¤ (í¬ë¡­ ë¡œì§)
        function fitCanvasToContainer(videoWidth, videoHeight) {
            const wrapperWidth = videoWrapper.clientWidth;
            const wrapperHeight = videoWrapper.clientHeight;
            
            const videoRatio = videoWidth / videoHeight;
            const wrapperRatio = wrapperWidth / wrapperHeight;

            if (canvasElement.width !== videoWidth || canvasElement.height !== videoHeight) {
                canvasElement.width = videoWidth;
                canvasElement.height = videoHeight;
            }

            if (videoRatio > wrapperRatio) {
                canvasElement.style.width = 'auto';
                canvasElement.style.height = '100%';
            } else {
                canvasElement.style.width = '100%';
                canvasElement.style.height = 'auto';
            }
        }

        function playPopSound() {
            loseSound.currentTime = 0;
            loseSound.play().catch(()=>{});
        }
        
        ['touchstart', 'click'].forEach(evt => {
            document.body.addEventListener(evt, () => {
                if(loseSound.paused) {
                    loseSound.play().then(() => {
                        loseSound.pause();
                        loseSound.currentTime = 0;
                    }).catch(()=>{});
                }
            }, { once: true });
        });

        function triggerConfetti() {
            const rect = machineResultElement.getBoundingClientRect();
            const x = (rect.left + rect.width / 2) / window.innerWidth;
            const y = (rect.top + rect.height / 2) / window.innerHeight;
            confetti({ particleCount: 80, spread: 60, startVelocity: 30, origin: { x: x, y: y }, zIndex: 9999 });
        }

        function isFingerExtended(landmarks, fingerTipIndex, fingerPipIndex) {
            return landmarks[fingerTipIndex].y < landmarks[fingerPipIndex].y;
        }

        function determineGesture(landmarks) {
            const thumbOpen = isFingerExtended(landmarks, 4, 2);
            const indexOpen = isFingerExtended(landmarks, 8, 6);
            const middleOpen = isFingerExtended(landmarks, 12, 10);
            const ringOpen = isFingerExtended(landmarks, 16, 14);
            const pinkyOpen = isFingerExtended(landmarks, 20, 18);
            
            let gesture = 'Unknown';
            let otherFingersCount = [indexOpen, middleOpen, ringOpen, pinkyOpen].filter(Boolean).length;
            
            if (otherFingersCount >= 3 && thumbOpen || otherFingersCount === 4) gesture = 'Paper';
            else if (indexOpen && middleOpen && !ringOpen && !pinkyOpen) gesture = 'Scissors';
            else if (thumbOpen && indexOpen && !middleOpen && !ringOpen && !pinkyOpen) gesture = 'Scissors';
            else if (otherFingersCount === 0 || (otherFingersCount === 0 && thumbOpen)) gesture = 'Rock';
            return gesture;
        }

        function onResults(results) {
            if (!modelLoaded) {
                loadingMsg.style.display = 'none';
                modelLoaded = true;
                statusText.innerText = "System Ready.";
            }

            // ë§¤ í”„ë ˆì„ ë¹„ìœ¨ ì¡°ì • (ì°Œê·¸ëŸ¬ì§ ë°©ì§€)
            fitCanvasToContainer(results.image.width, results.image.height);

            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const landmarks = results.multiHandLandmarks[0];

                // ì„  ë‘ê»˜ 6, ì› í¬ê¸° 6ìœ¼ë¡œ ì„¤ì •
                drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, {
                    color: '#00FF00',
                    lineWidth: 6 
                });
                drawLandmarks(canvasCtx, landmarks, {
                    color: '#FF0000',
                    lineWidth: 2,
                    radius: 6
                });

                const userGesture = determineGesture(landmarks);
                
                if (userGesture !== 'Unknown') {
                    let machineMove = '';
                    if (userGesture === 'Rock') machineMove = 'Paper';
                    else if (userGesture === 'Paper') machineMove = 'Scissors';
                    else if (userGesture === 'Scissors') machineMove = 'Rock';

                    machineResultElement.innerText = EMOTIONS[machineMove];
                    statusText.innerText = "Machine Won!";
                    statusText.style.color = '#e74c3c';

                    const currentTime = Date.now();
                    if (userGesture !== previousGesture) {
                        if (currentTime - lastWinTime > COOLDOWN_MS) {
                            triggerConfetti();
                            playPopSound();
                            machineScore++;
                            machineScoreEl.innerText = machineScore;
                            lastWinTime = currentTime;
                        }
                    }
                    previousGesture = userGesture;
                } else {
                   machineResultElement.innerText = 'âš™ï¸';
                   statusText.innerText = "Show your hand...";
                   statusText.style.color = '#f1c40f';
                   previousGesture = null; 
                }
            } else {
                machineResultElement.innerText = 'âš™ï¸';
                statusText.innerText = "Waiting for player...";
                statusText.style.color = '#bdc3c7';
                previousGesture = null;
            }
            canvasCtx.restore();
        }

        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.7, minTrackingConfidence: 0.7 });
        hands.onResults(onResults);

        // ì¹´ë©”ë¼ ì„¤ì •: í•´ìƒë„ë¥¼ ê°•ì œí•˜ì§€ ì•ŠìŒ (ì¹´ë©”ë¼ê°€ ì£¼ëŠ” ëŒ€ë¡œ ë°›ìŒ)
        const camera = new Camera(videoElement, {
            onFrame: async () => { await hands.send({image: videoElement}); }
        });
        camera.start();
    </script>
</body>
</html>