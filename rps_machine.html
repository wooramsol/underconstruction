<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Unbeatable RPS Machine</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #2c3e50;
            color: white;
            margin: 0; padding: 0;
            width: 100vw; height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        header {
            flex: 0 0 auto;
            text-align: center;
            padding: 20px 10px;
            background-color: #2c3e50;
            z-index: 10;
        }
        h1 { margin: 0; font-weight: 800; font-size: 2rem; line-height: 1.2; }
        .subtitle { margin: 0; color: #bdc3c7; font-size: 1.2rem; margin-top: 5px; }

        /* === [Í∏∞Î≥∏ Ïä§ÌÉÄÏùº: Î™®Î∞îÏùº Ïö∞ÏÑ† (Mobile First)] === */
        .game-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 15px;
            padding: 10px 20px;
            width: 100%;
            margin: 0 auto;
        }

        .player-section, .machine-section {
            width: 100%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .info-bar {
            display: flex;
            justify-content: space-between;
            width: 100%;
            padding: 0 5px;
            margin-bottom: 5px;
            align-items: flex-end;
        }
        h2 { margin: 0; font-size: 1.1rem; }
        .score-display { font-size: 1.1rem; font-weight: bold; color: #f1c40f; }

        .video-wrapper, .result-wrapper {
            width: 100%;
            aspect-ratio: 4 / 3;
            border-radius: 12px;
            border: 3px solid #3498db;
            background-color: #000;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        .result-wrapper {
            border-color: #95a5a6;
            background-color: #ecf0f1;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 8rem; 
            color: #2c3e50;
        }

        .vs-section {
            font-size: 1.5rem;
            font-weight: 900;
            font-style: italic;
            color: #ecf0f1;
            margin: -5px 0;
            z-index: 5;
            text-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        #input_video { display: none; }
        #output_canvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }

        #status_text {
            flex: 0 0 auto;
            padding: 15px;
            font-size: 1.2rem;
            font-weight: bold;
            color: #f1c40f;
            text-align: center;
            background-color: #2c3e50;
            width: 100%;
        }

        .loading {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: white; font-weight: bold;
        }

        /* === [PC/Ïõπ ÌôîÎ©¥ Ïä§ÌÉÄÏùº (900px Ïù¥ÏÉÅ)] === */
        @media (min-width: 900px) {
            h1 { font-size: 3rem; margin-bottom: 10px; }
            .subtitle { font-size: 1.5rem; margin-bottom: 30px; }

            .game-container {
                flex-direction: row;
                align-items: flex-start;
                gap: 50px;
                max-width: 1200px;
                padding-top: 40px;
            }

            .player-section, .machine-section {
                width: 420px;
                max-width: none;
            }

            .video-wrapper, .result-wrapper {
                width: 400px;
                height: 300px;
                aspect-ratio: auto;
                border-width: 4px;
            }

            .result-wrapper { font-size: 120px; }

            .vs-section {
                font-size: 3rem;
                margin: 0;
                padding-top: 100px;
                height: 300px;
                display: flex;
                align-items: center;
            }
            
            h2, .score-display { font-size: 1.5rem; }
            #status_text { font-size: 1.8rem; padding-bottom: 30px; }
        }
    </style>
</head>
<body>

    <header>
        <h1>ü§ñ Unbeatable Rock Paper Scissors Machine</h1>
        <p class="subtitle">Designed by Ramsol</p>
    </header>

    <div class="game-container">
        <div class="player-section">
            <div class="info-bar">
                <h2>You</h2>
                <div class="score-display">Wins: <span id="player_score">0</span></div>
            </div>
            <div class="video-wrapper">
                <div class="loading">Loading...</div>
                <video id="input_video" playsinline></video>
                <canvas id="output_canvas"></canvas>
            </div>
        </div>

        <div class="vs-section">VS</div>

        <div class="machine-section">
            <div class="info-bar">
                <h2>RPS Machine</h2>
                <div class="score-display">Wins: <span id="machine_score">0</span></div>
            </div>
            <div class="result-wrapper">
                <div id="machine_result_emoji">‚öôÔ∏è</div>
            </div>
        </div>
    </div>

    <div id="status_text">Show your hand!</div>
    <audio id="loseSound" src="https://actions.google.com/sounds/v1/cartoon/pop.ogg" preload="auto"></audio>

    <script>
        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const machineResultElement = document.getElementById('machine_result_emoji');
        const statusText = document.getElementById('status_text');
        const loadingMsg = document.querySelector('.loading');
        const machineScoreEl = document.getElementById('machine_score');
        const loseSound = document.getElementById('loseSound');
        loseSound.volume = 0.6;

        let machineScore = 0;
        let lastWinTime = 0; 
        const COOLDOWN_MS = 500; 
        let modelLoaded = false;
        let previousGesture = null;

        const EMOTIONS = { 'Rock': '‚úä', 'Paper': 'üñêÔ∏è', 'Scissors': '‚úåÔ∏è', 'Unknown': '‚ùì' };

        // Ï∫îÎ≤ÑÏä§ Ìï¥ÏÉÅÎèÑ Í≥†Ï†ï
        canvasElement.width = 1280;
        canvasElement.height = 720;

        function playPopSound() {
            loseSound.currentTime = 0;
            loseSound.play().catch(()=>{});
        }
        
        ['touchstart', 'click'].forEach(evt => {
            document.body.addEventListener(evt, () => {
                if(loseSound.paused) {
                    loseSound.play().then(() => {
                        loseSound.pause();
                        loseSound.currentTime = 0;
                    }).catch(()=>{});
                }
            }, { once: true });
        });

        function triggerConfetti() {
            const rect = machineResultElement.getBoundingClientRect();
            const x = (rect.left + rect.width / 2) / window.innerWidth;
            const y = (rect.top + rect.height / 2) / window.innerHeight;
            confetti({ particleCount: 80, spread: 60, startVelocity: 30, origin: { x: x, y: y }, zIndex: 9999 });
        }

        function isFingerExtended(landmarks, fingerTipIndex, fingerPipIndex) {
            return landmarks[fingerTipIndex].y < landmarks[fingerPipIndex].y;
        }

        function determineGesture(landmarks) {
            const thumbOpen = isFingerExtended(landmarks, 4, 2);
            const indexOpen = isFingerExtended(landmarks, 8, 6);
            const middleOpen = isFingerExtended(landmarks, 12, 10);
            const ringOpen = isFingerExtended(landmarks, 16, 14);
            const pinkyOpen = isFingerExtended(landmarks, 20, 18);
            
            let gesture = 'Unknown';
            let otherFingersCount = [indexOpen, middleOpen, ringOpen, pinkyOpen].filter(Boolean).length;
            
            if (otherFingersCount >= 3 && thumbOpen || otherFingersCount === 4) gesture = 'Paper';
            else if (indexOpen && middleOpen && !ringOpen && !pinkyOpen) gesture = 'Scissors';
            else if (thumbOpen && indexOpen && !middleOpen && !ringOpen && !pinkyOpen) gesture = 'Scissors';
            else if (otherFingersCount === 0 || (otherFingersCount === 0 && thumbOpen)) gesture = 'Rock';
            return gesture;
        }

        function onResults(results) {
            if (!modelLoaded) {
                loadingMsg.style.display = 'none';
                modelLoaded = true;
                statusText.innerText = "System Ready.";
            }

            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const landmarks = results.multiHandLandmarks[0];

                // [ÏàòÏ†ï] ÎìúÎ°úÏûâ ÎëêÍªòÎ•º 7Î°ú ÏÑ§Ï†ï
                drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, {
                    color: '#00FF00',
                    lineWidth: 7 
                });
                drawLandmarks(canvasCtx, landmarks, {
                    color: '#FF0000',
                    lineWidth: 2, // ÌÖåÎëêÎ¶¨ ÎëêÍªò
                    radius: 7     // Ïõê ÌÅ¨Í∏∞
                });

                const userGesture = determineGesture(landmarks);
                
                if (userGesture !== 'Unknown') {
                    let machineMove = '';
                    if (userGesture === 'Rock') machineMove = 'Paper';
                    else if (userGesture === 'Paper') machineMove = 'Scissors';
                    else if (userGesture === 'Scissors') machineMove = 'Rock';

                    machineResultElement.innerText = EMOTIONS[machineMove];
                    statusText.innerText = "Machine Won!";
                    statusText.style.color = '#e74c3c';

                    const currentTime = Date.now();
                    if (userGesture !== previousGesture) {
                        if (currentTime - lastWinTime > COOLDOWN_MS) {
                            triggerConfetti();
                            playPopSound();
                            machineScore++;
                            machineScoreEl.innerText = machineScore;
                            lastWinTime = currentTime;
                        }
                    }
                    previousGesture = userGesture;
                } else {
                   machineResultElement.innerText = '‚öôÔ∏è';
                   statusText.innerText = "Show your hand...";
                   statusText.style.color = '#f1c40f';
                   previousGesture = null; 
                }
            } else {
                machineResultElement.innerText = '‚öôÔ∏è';
                statusText.innerText = "Waiting for player...";
                statusText.style.color = '#bdc3c7';
                previousGesture = null;
            }
            canvasCtx.restore();
        }

        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.7, minTrackingConfidence: 0.7 });
        hands.onResults(onResults);

        const camera = new Camera(videoElement, {
            onFrame: async () => { await hands.send({image: videoElement}); },
            width: 1280, 
            height: 720
        });
        camera.start();
    </script>
</body>
</html>